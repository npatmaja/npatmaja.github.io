<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>

    <script type="text/javascript">
        if (window.location.hostname == 'www.nauvalatmaja.com' || window.location.hostname == 'nauvalatmaja.com') {

          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-58073141-1', 'auto');
          ga('send', 'pageview');  
        }
    </script>

    <title>Upload Files with Backbone.js, Node.js and express 4.x | nauval atmaja</title>
    <meta name="author" content="Nauval Atmaja">
    <meta name="description" content="Nauval Atmaja's personal notes on software development and all that">
    <meta name="keywords" content="software, engineering, software engineering, architecture, software architecture, programming, thought, javascript, node.js, ruby on rails, java, HTML, code, hack, tips, trick, *nix, OSX">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="/feed.xml" rel="alternate" title="www.nauvalatmaja.com" type="application/atom+xml">
    <!-- <link rel="icon" sizes="300x300" href="icon/icon.png"> -->
    <!-- <link rel="icon" sizes="196x196" href="icon/icon-196.png"> -->
    <!-- <link rel="icon" sizes="128x128" href="icon/icon-128.png"> -->
    <!-- <link rel="apple-touch-icon" sizes="128x128" href="icon/icon-128.png"> -->
    <!-- <link rel="apple-touch-icon-precomposed" sizes="128x128" href="icon/icon-128.png"> -->
    <link href="/ico/favicon.ico" rel="shortcut icon">

    <!-- Bootstrap -->
    <link href="/styles/site.css?" rel="stylesheet" media="screen">
    <link rel="stylesheet" type="text/css" href="/vendor/rainbow.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="/scripts/vendor/html5shiv.js"></script>
    <script src="/scripts/vendor/respond.min.js"></script>
    <![endif]-->

    <meta name="generator" content="DocPad v6.69.2" />
    
</head>
<body>

<a href="https://plus.google.com/112846605467404730226?rel=author" class="google googleplus-hidden" title="Google+">Google+</a>

<div class="navbar navbar-default navbar-static-top navbar-shadow">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/"><span class="text-primary">nauval atmaja</span></a>
        </div>
        <div class="collapse navbar-collapse navbar-right">
            <ul class="nav navbar-nav">
                <!--<li><a href="/">Blog</a></li>-->
                <!-- <li><a href="/archives/">Archives</a></li> -->
                
                    <li typeof="sioc:Page", about= /pages/archives/>
                      <a href='/pages/archives/', property="dc:title">Blog Archives</a>
                    </li>
                
                <li class="hidden-xs">
                    <a href="/feed.xml" class="rss"><span class="icon icon-feed"></span></a>
                    <a href="https://twitter.com/novalpas" class="twitter"><span class="icon icon-twitter"></span></a>
                    <a href="https://github.com/npatmaja" class="github"><span class="icon icon-github"></span></a>
                    <a href="https://id.linkedin.com/in/nauvalatmaja/" class="linkedin"><span class="icon icon-linkedin"></span></a>
                </li>
            </ul>
            <form class="navbar-form navbar-right hidden-xs" role="search" action="http://google.com/search"
                  method="get">
                <div class="form-group">
                    <input type="search" name="q" class="form-control" placeholder="Search">
                    <input type="hidden" name="q" value="site:www.nauvalatmaja.com">
                </div>
            </form>
        </div>
    </div>
</div>
<div class="clear">
<div class="container">
    <div class="row">
        <div class="col-sm-12 col-md-10">
            
            <article id="post" class="post">
    
        <h1>Upload Files with Backbone.js, Node.js and express 4.x</h1>
    
    <div class="post-date">Jan 30th, 2015</div>
    <div class="post-content">
        <p><a href="https://github.com/addyosmani/backbone-fundamentals">Backbone fundamentals</a>
is a great <em>free</em> resource to learn Backbone.js from scratch. The book was written by 
<a href="http://addyosmani.com/">Addy Osmany</a> under <a href="https://en.wikipedia.org/wiki/Creative_Commons_license">creative-commons license</a>.
As its second exercise, the book guide the readers to create a simple library application
that uses Node.js as the back-end. However, it left the part to upload book&#39;s cover
to the readers as an exercise. Hence, here is the way I did it.</p>
<h1 id="requirement">Requirement</h1>
<p>There are two additional requirements for the upload book&#39;s cover features:</p>
<ul>
<li><p>The selected cover should be previewed as thumbnail</p>
<p>This implies that there should be a space to show the selected
image. When users change the image, the preview should change 
accordingly.</p>
</li>
<li><p>Upload process shall happen only when a new book is added</p>
<p>The upload happens if and only if when users click the button
to add a new book. This signifies that the displaying the cover&#39;s
preview should not upload to image file to the server.</p>
</li>
</ul>
<h1 id="problems">Problems</h1>
<p>After browsing for awhile, I found <a href="http://markdawson.tumblr.com/post/18359176420/asynchronous-file-uploading-using-express-and">a blog post to upload file asynchronously using Node.js and express</a>, which was good
as a starting point. However, similar to most of online references I had found, 
they were pretty much obsolete; most of them were using express &lt;= 3.x that supported file upload
by using <code>body-parse</code> middleware (as mentioned in the blog post) where in express
4.x the <code>body-parse</code> middleware did not support file upload any longer.</p>
<p>Another problem was to address the requirement: previewing images without
upload them to the server in the first place. This was tricky, as most of the 
solutions were to have the images uploaded first then fetch the images&#39; URL 
to be previewed.</p>
<h1 id="solution">Solution</h1>
<p>I had to admit, the first problem is another RTFM problem. So when I read again
<a href="https://github.com/expressjs/body-parser"><code>body-parser</code>&#39;s documentation</a> it was
written clearly that <code>body-parse</code> did not handle multipart bodies (file uploads).
Furthermore, it mentioned the alternatives modules to handle multipart bodies, and
one of them is <a href="https://www.npmjs.com/package/multer#readme">multer</a>.</p>
<p>Just like another express middleware, I needed to tell express to use multer and
specified to which directory the files will be uploaded as shown in the following
coffeescript code (yes, I wrote the back-end using coffeescript).</p>
<pre class="highlight"><code class="hljs coffeescript">express = <span class="hljs-built_in">require</span> <span class="hljs-string">'express'</span>
multer = <span class="hljs-built_in">require</span> <span class="hljs-string">'multer'</span>

app = express()
app.use multer( { <span class="hljs-attribute">dest</span>: <span class="hljs-string">"<span class="hljs-subst">#{__root}</span>/public/img/covers/"</span> } )
</code></pre>
<p>For the second problem, I found out that javascript provides a 
<a href="https://developer.mozilla.org/en-US/docs/Web/API/FileReader"><code>FileReader</code> object whose capable of reading file from client&#39;s machine</a>, 
<a href="https://developer.mozilla.org/en-US/docs/Using_files_from_web_applications#Example.3A_Showing_thumbnails_of_user-selected_images">which could be used to load a selected image from a browser locally</a>.</p>
<p>The following code is a Backbone view to handle the feature to display the selected image.
The main idea is to catch the <code>change</code> event from an <code>&lt;input type=&quot;file&quot;&gt;</code> and read the file
and render it through the designated <code>&lt;img&gt;</code> element and later on to upload the file as well.</p>
<pre class="highlight"><code class="hljs javascript">app.ThumbnailView = Backbone.View.extend({
  events: {
    <span class="hljs-string">'change #coverImageUpload'</span>: <span class="hljs-string">'renderThumb'</span>,
    <span class="hljs-string">'submit #uploadCoverForm'</span>: <span class="hljs-string">'upload'</span>
  },

  render: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.renderThumb();
  },

  renderThumb: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> input = <span class="hljs-keyword">this</span>.$(<span class="hljs-string">'#coverImageUpload'</span>);
    <span class="hljs-keyword">var</span> img = <span class="hljs-keyword">this</span>.$(<span class="hljs-string">'#uploadedImage'</span>)[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">if</span>(input.val() !== <span class="hljs-string">''</span>) {
      <span class="hljs-keyword">var</span> selected_file = input[<span class="hljs-number">0</span>].files[<span class="hljs-number">0</span>];
      <span class="hljs-keyword">var</span> reader = <span class="hljs-keyword">new</span> FileReader();
      reader.onload = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(aImg)</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{ aImg.src = e.target.result; }; })(img);
      reader.readAsDataURL(selected_file);
    }
  },

  submit: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.$form = <span class="hljs-keyword">this</span>.$(<span class="hljs-string">'#uploadCoverForm'</span>);
    <span class="hljs-keyword">this</span>.$form.submit();
  },

  upload: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> _this = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">this</span>.$form.ajaxSubmit({
      error: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(xhr)</span> </span>{
        _this.renderStatus(<span class="hljs-string">'Error: '</span> + xhr.status);
      },
      success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(response)</span> </span>{
        _this.trigger(<span class="hljs-string">'image-uploaded'</span>, response.path);
        _this.clearField();
      }
    });
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  },

  renderStatus: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(status)</span> </span>{
     $(<span class="hljs-string">'#status'</span>).text(status);
  },

  clearField: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.$(<span class="hljs-string">'#uploadedImage'</span>)[<span class="hljs-number">0</span>].src = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">this</span>.$(<span class="hljs-string">'#coverImageUpload'</span>).val(<span class="hljs-string">''</span>);
  }
});
</code></pre><p>In details, when a user has selected a cover image, the <code>&#39;change #coverImageUpload&#39;: &#39;renderThumb&#39;</code> 
event will be triggered. To add a bit context, <code>#coverImageUpload</code> is the id of the <code>&lt;input type=&quot;file&quot;&gt;</code>
to upload a file and <code>renderThumb</code> is the function will be executed as the event&#39;s callback. In the
function, whenever a user selected a picture, the view will get the selected file and read the file
as data URL through <code>FileReader.readAsDataURL</code> function. When the particular function is executed,
it triggers <code>FileReader</code>&#39;s <code>onload</code> event with the result of the data reading process as its callback&#39;s
parameter, which is used as the image source of the <code>&lt;img&gt;</code> element as shown in the listing above.</p>
<p>The uploading part was a bit tricky. I used Backbone View&#39;s event to make sure
that the newly added book has the right cover image. The way to do this is to
make sure when a user clicks the <strong>add book button</strong>, the cover image
will be uploaded first and when the the upload success an event will be 
triggered with the server path of the uploaded image as the parameter. Then the path will 
be used as the value of <code>&lt;input&gt;</code> related to the book cover. The last step
is to create the book object in the Backbone Collection, which will be 
sync&#39;d to the Node.js back-end server. The following sequence diagram 
pictures the description above.</p>
<div class="mermaid">
sequenceDiagram
  User->>LibraryView: click add book button
  LibraryView->>ThumbnailView: upload
  ThumbnailView->>ThumbnailView: trigger('uploaded', response.path)
  opt uploaded event
    LibraryView->>LibraryView: updateInput
    LibraryView->>LibraryView: createData
  end
</div>
<p>To enable the event in the <code>LibraryView</code>, the object needs to listen to
to the <code>ThumbnailView</code>.</p>
<pre class="highlight"><code class="hljs actionscript">app.LibraryView = Backbone.View.extend({
  ...

  initialize: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(initialBooks)</span> </span>{
    <span class="hljs-keyword">this</span>.collection = <span class="hljs-keyword">new</span> app.Library(initialBooks);

    <span class="hljs-keyword">this</span>.thumbnailView = <span class="hljs-keyword">new</span> app.ThumbnailView();
    <span class="hljs-keyword">this</span>.bookListView = <span class="hljs-keyword">new</span> app.BookListView( { collection: <span class="hljs-keyword">this</span>.collection } );

    <span class="hljs-keyword">this</span>.listenTo(<span class="hljs-keyword">this</span>.thumbnailView, <span class="hljs-string">'image-uploaded'</span>, <span class="hljs-keyword">this</span>.updateInput);
  }
}
</code></pre><p>And that&#39;s all folks! I hope this tutorial could be a help for someone who looks for the solution
for the exercise. Please see the <a href="https://github.com/npatmaja/library">project&#39;s repository</a> 
for the complete solution.</p>

    </div>
    
        <div class="twitter-share">
  <a href='https://twitter.com/intent/tweet?text=Upload+Files+with+Backbone.js,+Node.js+and+express+4.x&url=http://nauvalatmaja.com/2015/01/30/upload-files-with-backbone-nodejs-express-4/&via=novalpas&hashtags=Node.js%2Cexpress%2CBackbone.js%2Cupload%2Cmulter%2CBackbone Fundamentals' class='twitter-share-button' data-via='novalpas' data-count= 'none'><img src='/ico/twitter_white_small.png', width='16px', height='16px'/>tweet</a>
</div>

    
    
        <div class="post-tags">
            Posted In: 
  <a href='/tags/node-js/'>Node.js</a>

  <a href='/tags/express/'>express</a>

  <a href='/tags/backbone-js/'>Backbone.js</a>

  <a href='/tags/upload/'>upload</a>

  <a href='/tags/multer/'>multer</a>

  <a href='/tags/backbone-fundamentals/'>Backbone Fundamentals</a>
 
        </div>
    
</article> 
            <!-- get next and prev link -->
            
            <div class="page-nav">
              
                
                    
                    
                         <a href="/2015/01/13/rendering-mermaid-in-docpad/" class="page-nav-older">
                          <span class="icon icon-arrow-left-2"></span> Rendering Mermaid in Docpad
                        </a>
                    
                
              
                
              
                
              
                
              
                
              
                
              
            </div>
            <div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<script type="text/javascript">
    var disqus_shortname = 'nauvalatmaja';
    var disqus_url = 'http://nauvalatmaja.com/2015/01/30/upload-files-with-backbone-nodejs-express-4/';
    var disqus_identifier = disqus_url;
    var disqus_title = 'Upload Files with Backbone.js, Node.js and express 4.x';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

            <div id="me">
    <p>
        <img src="/images/avatar.png", alt="nauval atmaja">
        Hello, I'm Nauval Atmaja, a software developer who has interest in software architecture and new cool stuff. 
        Unfortunately, I'm no gamer myself but I will still have fun playing Winning Eleven or Pro Evolution Soccer.
        Have a look around and don't hesitate to <a href="mailto:nauval.atmaja@gmail.com">contact me</a> with any comments,
        suggestions or even to just say Hi!
    </p>
    <p>
        <a href="https://twitter.com/novalpas/">@novalpas</a> &#8226;
        <a href="https://github.com/npatmaja">GitHub</a> &#8226;
        <a href="https://id.linkedin.com/in/nauvalatmaja/">linkedin</a> &#8226;
        <a href="mailto:nauval.atmaja@gmail.com">Email Me</a>
    </p>
</div>

        </div>
    </div>
</div>
<div class="container">
    <div class="navbar navbar-footer">
        <p class="navbar-center navbar-text">© Nauval Atmaja 2014</p>
    </div>
</div>


<script src="/vendor/jquery/dist/jquery.js"></script>
<script src="/vendor/mermaid.full.min.js"></script>
<script src="/vendor/components-bootstrap/js/bootstrap.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.pack.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/coffee-script/1.6.3/coffee-script.min.js"></script>



<script type="text/javascript">
	var $buoop = {
		url: 'http://whatbrowser.org/',
        reminder: 0,
		newwindow: false,
		'text': 'You are using an outdated browser (%s). <a%s>More information &#187;</a>',
		'text_af': 'Jy gebruik \'n verouderde webblaaier (%s). <a%s>Meer inligting &#187;</a>',
		'text_cs': 'Používáte zastaralý prohlížeč (%s). <a%s>Více informací &#187;</a>',
		'text_da': 'Du bruger en ældre browser (%s). <a%s>Mere information &#187;</a>',
		'text_de': 'Sie benutzen einen veralteten Browser (%s). <a%s>Mehr Informationen &#187;</a>',
		'text_el': 'Χρησιμοποιείτε ένα ξεπερασμένο πρόγραμμα περιήγησης. <a%s>Περισσότερες πληροφορίες &#187;</a>',
		'text_es': 'Su navegador está obsoleto (%s). <a%s>M&aacute;s informaci&oacute;n &#187;</a>',
		'text_fi': 'Käytät vanhentunutta selainta (%s). <a%s>Lisää tietoa &#187;</a>',
		'text_fr': 'Votre navigateur n\'est pas à jour (%s). <a%s>Plus d\'information &#187;</a>',
		'text_hu': 'A böngészője elavult (%s). <a%s>További információ &#187;</a>',
		'text_id': 'Anda menggunakan web browser versi lama (%s). <a%s>Informasi selengkapnya &#187;</a>',
		'text_is': 'Þú ert að nota úreltan vafra (%s). <a%s>Nánari upplýsingar &#187;</a>',
		'text_it': 'Stai usando un browser datato (%s). <a%s>Ulteriori informazioni &#187;</a>',
		'text_nl': 'U gebruikt op dit moment een verouderde webbrowser (%s). <a%s>Meer informatie &#187;</a>',
		'text_pl': 'Używasz przestarzałej przeglądarki (%s). <a%s>Więcej informacji &#187;</a>',
		'text_pt': 'Você está usando um navegador antigo (%s). <a%s>Mais informações &#187;</a>',
		'text_ro': 'Browserul dumneavoastră este depăşit (%s). <a%s>Mai multe informații &#187;</a>',
		'text_ru': 'Вы используете устаревший браузер (%s). <a%s>Подробнее &#187;</a>',
		'text_sk': 'Používate zastaralý prehliadač (%s). <a%s>Viac informácií &#187;</a>',
		'text_sr': 'Vi koristite zastarelu verziju browsera (%s). <a%s>Vi&#353;e informacija &#187;</a>',
		'text_sv': 'Du använder en gammal webbläsare (%s). <a%s>Mer information &#187;</a>',
		'text_tr': 'Çok eski bir tarayıcı kullanıyorsunuz (%s). <a%s>Daha fazla bilgi &#187;</a>',
		'text_vi': 'Trình duyệt bạn dùng đã lỗi thời rồi (%s). <a%s>Thêm thông tin &#187;</a>'
	};
	$buoop.ol = window.onload;
	window.onload=function(){
		try {if ($buoop.ol) $buoop.ol();}catch (e) {}
		var e = document.createElement("script");
		e.setAttribute("type", "text/javascript");
		e.setAttribute("src", "//browser-update.org/update.js");
		document.body.appendChild(e);
	}
</script>

</body>
</html>