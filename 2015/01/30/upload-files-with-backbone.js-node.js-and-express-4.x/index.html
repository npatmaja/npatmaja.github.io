<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <title>
    Upload Files with Backbone.js, Node.js and express 4.x // nauval atmaja
  </title>

  <link href="http://gmpg.org/xfn/11" rel="profile">
<meta http-equiv="content-type" content="text/html; charset=utf-8">


<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

<meta name="description" content="">
<meta name="keywords" content="">
<meta name="author" content="">
<meta name="generator" content="Hugo 0.15" />

  <meta property="og:title" content="Upload Files with Backbone.js, Node.js and express 4.x" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:locale" content="en_US" />
<meta property="og:url" content="http://nauvalatmaja.com/2015/01/30/upload-files-with-backbone.js-node.js-and-express-4.x/" />


  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/base-min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/pure-min.css">
  
  
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/grids-responsive-min.css">
  
  

  <link rel="stylesheet" href="http://nauvalatmaja.com//css/redlounge.css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
  <link href='//fonts.googleapis.com/css?family=Raleway:400,200,100,700,300,500,600,800' rel='stylesheet' type='text/css'>
  <link href='//fonts.googleapis.com/css?family=Libre+Baskerville:400,700,400italic' rel='stylesheet' type='text/css'>

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  <link href="" rel="alternate" type="application/rss+xml" title="nauval atmaja" />

    
  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/styles/tomorrow-night-bright.min.css">
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>


  

  

  <link rel="stylesheet" href="http://nauvalatmaja.com//css/custom.css">
<link rel="stylesheet" href="http://nauvalatmaja.com//css/404.css">


  <script>
    if (window.location.hostname != "localhost") {
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', "UA-58073141-1", 'auto');
      ga('send', 'pageview');
    }
  </script>


</head>

<body>
	
		<div id="nav-to-top">
			<a href="#top">
				<i class="fa fa-angle-double-up"> </i>
				To Top
			</a>
		</div>
	

	<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
  <div class="header">
    

    

    
        <h1 class="brand-title">
          <a class="title" href="http://nauvalatmaja.com/">
          <span class="nav-item-separator">//</span>nauval atmaja
        </a>
        </h1>
    
    
      <h2 class="brand-tagline">Thoughts on software, product, technology, and anything related</h2>
    

    <nav class="nav">
      <ul class="nav-list">
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/post/">archives</a></li>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/categories/">categories</a></li>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/series/">series</a></li>
        
      </ul>
    </nav>

    
    <div class="social-buttons">
      
        
        <a href="http://www.github.com/npatmaja" target="_blank"><i class='fa fa-github fa-2x'></i></a>
        
      
        
        <a href="https://id.linkedin.com/in/nauvalatmaja/" target="_blank"><i class='fa fa-linkedin-square fa-2x'></i></a>
        
      
        
        <a href="http://www.twitter.com/novalpas" target="_blank"><i class='fa fa-twitter fa-2x'></i></a>
        
      
        
        <a href="https://noval78.wordpress.com/" target="_blank"><i class='fa fa-wordpress fa-2x'></i></a>
        
      

    </div>
    
  </div>
</div>


		

    <div class="content pure-u-1 pure-u-md-3-4">
			<a name="top"></a>
			

			
				
			    <div id="toc" class="pure-u-1 pure-u-md-1-4">
					<small class="toc-label">Contents</small>
			   	 	<nav id="TableOfContents">
<ul>
<li><a href="#requirement:924a8100561ff551d1d1e3f51a0c8593">Requirement</a></li>
<li><a href="#problems:924a8100561ff551d1d1e3f51a0c8593">Problems</a></li>
<li><a href="#solution:924a8100561ff551d1d1e3f51a0c8593">Solution</a></li>
</ul>
</nav>
			    </div>
		    
	    
			<div class="wrapper">
				<section class="post">
					<header class="post-header">
						<h1 class="post-title">
							Upload Files with Backbone.js, Node.js and express 4.x
						</h1>
						<h3 class="post-subtitle">
		        	
		        </h3>
					</header>
	        
	        	<span class="post-date">
							<span class="post-date-day"><span class="post-date-month">Jan 30, 2015</span> </span>
	        	</span>
	        

	        
	        	
	        

					
					
						<div class="post-categories">
						
							<a class="post-category post-category-web" href="http://nauvalatmaja.com//categories/web">Web</a>
						
							<a class="post-category post-category-development" href="http://nauvalatmaja.com//categories/development">Development</a>
						
						</div>
					

					
			    	<div class="social-sharing">
	<a class="share-button-facebook" onClick="return popupShare(this.href);" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fnauvalatmaja.com%2f2015%2f01%2f30%2fupload-files-with-backbone.js-node.js-and-express-4.x%2f" target="_blank"><i class="fa fa-facebook"><span>Like</span></i></a>
	<a class="share-button-google-plus" onClick="return popupShare(this.href);" href="https://plus.google.com/share?url=http%3a%2f%2fnauvalatmaja.com%2f2015%2f01%2f30%2fupload-files-with-backbone.js-node.js-and-express-4.x%2f" target="_blank"><i class="fa fa-google-plus"><span>Google +1</span></i></a>
	<a class="share-button-linkedin" onClick="return popupShare(this.href);" href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fnauvalatmaja.com%2f2015%2f01%2f30%2fupload-files-with-backbone.js-node.js-and-express-4.x%2f&title=Upload%20Files%20with%20Backbone.js%2c%20Node.js%20and%20express%204.x&summary=Backbone%20fundamentals%20is%20a%20great%20free%20resource%20to%20learn%20Backbone.js%20from%20scratch.%20The%20book%20was%20written%20by%20Addy%20Osmany%20under%20creative-commons%20license.%20As%20its%20second%20exercise%2c%20the%20book%20guide%20the%20readers%20to%20create%20a%20simple%20library%20application%20that%20uses%20Node.js%20as%20the%20back-end.%20However%2c%20it%20left%20the%20part%20to%20upload%20book%26rsquo%3bs%20cover%20to%20the%20readers%20as%20an%20exercise.%20Hence%2c%20here%20is%20the%20way%20I%20did%20it.%20Requirement%20There%20are%20two%20additional%20requirements%20for%20the%20upload%20book%26rsquo%3bs%20cover%20features%3a%20-%20The%20selected%20cover%20should%20be%20previewed%20as%20thumbnail%20This%20implies%20that%20there%20should%20be%20a%20space%20to%20show%20the%20selected%20image.}&source=nauval%20atmaja" target="_blank"><i class="fa fa-linkedin"><span>Share on LinkedIn</span></i></a>
	<a class="share-button-twitter" onClick="return popupShare(this.href);" href="http://twitter.com/share?text=Upload%20Files%20with%20Backbone.js%2c%20Node.js%20and%20express%204.x&url=http%3a%2f%2fnauvalatmaja.com%2f2015%2f01%2f30%2fupload-files-with-backbone.js-node.js-and-express-4.x%2f" target="_blank"><i class="fa fa-twitter"><span>Tweet</span></i></a>	
</div>
			    

					

	  			

<p><a href="https://github.com/addyosmani/backbone-fundamentals">Backbone fundamentals</a>
is a great <em>free</em> resource to learn Backbone.js from scratch. The book was written by
<a href="http://addyosmani.com/">Addy Osmany</a> under <a href="https://en.wikipedia.org/wiki/Creative_Commons_license">creative-commons license</a>.
As its second exercise, the book guide the readers to create a simple library application
that uses Node.js as the back-end. However, it left the part to upload book&rsquo;s cover
to the readers as an exercise. Hence, here is the way I did it.</p>

<h1 id="requirement:924a8100561ff551d1d1e3f51a0c8593">Requirement</h1>

<p>There are two additional requirements for the upload book&rsquo;s cover features:
- The selected cover should be previewed as thumbnail</p>

<p>This implies that there should be a space to show the selected
  image. When users change the image, the preview should change
  accordingly.</p>

<ul>
<li>Upload process shall happen only when a new book is added</li>
</ul>

<p>The upload happens if and only if when users click the button
  to add a new book. This signifies that the displaying the cover&rsquo;s
  preview should not upload to image file to the server.</p>

<!-- Read more -->

<h1 id="problems:924a8100561ff551d1d1e3f51a0c8593">Problems</h1>

<p>After browsing for awhile, I found <a href="http://markdawson.tumblr.com/post/18359176420/asynchronous-file-uploading-using-express-and">a blog post to upload file asynchronously using Node.js and express</a>, which was good
as a starting point. However, similar to most of online references I had found,
they were pretty much obsolete; most of them were using express &lt;= 3.x that supported file upload
by using <code>body-parse</code> middleware (as mentioned in the blog post) where in express
4.x the <code>body-parse</code> middleware did not support file upload any longer.</p>

<p>Another problem was to address the requirement: previewing images without
upload them to the server in the first place. This was tricky, as most of the
solutions were to have the images uploaded first then fetch the images&rsquo; URL
to be previewed.</p>

<h1 id="solution:924a8100561ff551d1d1e3f51a0c8593">Solution</h1>

<p>I had to admit, the first problem is another RTFM problem. So when I read again
<a href="https://github.com/expressjs/body-parser"><code>body-parser</code>&rsquo;s documentation</a> it was
written clearly that <code>body-parse</code> did not handle multipart bodies (file uploads).
Furthermore, it mentioned the alternatives modules to handle multipart bodies, and
one of them is <a href="https://www.npmjs.com/package/multer#readme">multer</a>.</p>

<p>Just like another express middleware, I needed to tell express to use multer and
specified to which directory the files will be uploaded as shown in the following
coffeescript code (yes, I wrote the back-end using coffeescript).</p>

<pre><code class="language-coffeescript">express = require 'express'
multer = require 'multer'

app = express()
app.use multer( { dest: &quot;#{__root}/public/img/covers/&quot; } )
</code></pre>

<p>For the second problem, I found out that javascript provides a
<a href="https://developer.mozilla.org/en-US/docs/Web/API/FileReader"><code>FileReader</code> object whose capable of reading file from client&rsquo;s machine</a>,
<a href="https://developer.mozilla.org/en-US/docs/Using_files_from_web_applications#Example.3A_Showing_thumbnails_of_user-selected_images">which could be used to load a selected image from a browser locally</a>.</p>

<p>The following code is a Backbone view to handle the feature to display the selected image.
The main idea is to catch the <code>change</code> event from an <code>&lt;input type=&quot;file&quot;&gt;</code> and read the file
and render it through the designated <code>&lt;img&gt;</code> element and later on to upload the file as well.</p>

<pre><code>app.ThumbnailView = Backbone.View.extend({
  events: {
    'change #coverImageUpload': 'renderThumb',
    'submit #uploadCoverForm': 'upload'
  },

  render: function () {
    this.renderThumb();
  },

  renderThumb: function () {
    var input = this.$('#coverImageUpload');
    var img = this.$('#uploadedImage')[0];
    if(input.val() !== '') {
      var selected_file = input[0].files[0];
      var reader = new FileReader();
      reader.onload = (function(aImg) { return function(e) { aImg.src = e.target.result; }; })(img);
      reader.readAsDataURL(selected_file);
    }
  },

  submit: function () {
    this.$form = this.$('#uploadCoverForm');
    this.$form.submit();
  },

  upload: function () {
    var _this = this;
    this.$form.ajaxSubmit({
      error: function (xhr) {
        _this.renderStatus('Error: ' + xhr.status);
      },
      success: function (response) {
        _this.trigger('image-uploaded', response.path);
        _this.clearField();
      }
    });
    return false;
  },

  renderStatus: function (status) {
     $('#status').text(status);
  },

  clearField: function () {
    this.$('#uploadedImage')[0].src = '';
    this.$('#coverImageUpload').val('');
  }
});
</code></pre>

<p>In details, when a user has selected a cover image, the <code>'change #coverImageUpload': 'renderThumb'</code>
event will be triggered. To add a bit context, <code>#coverImageUpload</code> is the id of the <code>&lt;input type=&quot;file&quot;&gt;</code>
to upload a file and <code>renderThumb</code> is the function will be executed as the event&rsquo;s callback. In the
function, whenever a user selected a picture, the view will get the selected file and read the file
as data URL through <code>FileReader.readAsDataURL</code> function. When the particular function is executed,
it triggers <code>FileReader</code>&rsquo;s <code>onload</code> event with the result of the data reading process as its callback&rsquo;s
parameter, which is used as the image source of the <code>&lt;img&gt;</code> element as shown in the listing above.</p>

<p>The uploading part was a bit tricky. I used Backbone View&rsquo;s event to make sure
that the newly added book has the right cover image. The way to do this is to
make sure when a user clicks the <strong>add book button</strong>, the cover image
will be uploaded first and when the the upload success an event will be
triggered with the server path of the uploaded image as the parameter. Then the path will
be used as the value of <code>&lt;input&gt;</code> related to the book cover. The last step
is to create the book object in the Backbone Collection, which will be
sync&rsquo;d to the Node.js back-end server. The following sequence diagram
pictures the description above.</p>

<pre><code>sequenceDiagram
  User-&gt;&gt;LibraryView: click add book button
  LibraryView-&gt;&gt;ThumbnailView: upload
  ThumbnailView-&gt;&gt;ThumbnailView: trigger('uploaded', response.path)
  opt uploaded event
    LibraryView-&gt;&gt;LibraryView: updateInput
    LibraryView-&gt;&gt;LibraryView: createData
  end
</code></pre>

<p>To enable the event in the <code>LibraryView</code>, the object needs to listen to
to the <code>ThumbnailView</code>.</p>

<pre><code>app.LibraryView = Backbone.View.extend({
  ...

  initialize: function (initialBooks) {
    this.collection = new app.Library(initialBooks);

    this.thumbnailView = new app.ThumbnailView();
    this.bookListView = new app.BookListView( { collection: this.collection } );

    this.listenTo(this.thumbnailView, 'image-uploaded', this.updateInput);
  }
}
</code></pre>

<p>And that&rsquo;s all folks! I hope this tutorial could be a help for someone who looks for the solution
for the exercise. Please see the <a href="https://github.com/npatmaja/library">project&rsquo;s repository</a>
for the complete solution.</p>


					
			    	<div class="social-sharing">
	<a class="share-button-facebook" onClick="return popupShare(this.href);" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fnauvalatmaja.com%2f2015%2f01%2f30%2fupload-files-with-backbone.js-node.js-and-express-4.x%2f" target="_blank"><i class="fa fa-facebook"><span>Like</span></i></a>
	<a class="share-button-google-plus" onClick="return popupShare(this.href);" href="https://plus.google.com/share?url=http%3a%2f%2fnauvalatmaja.com%2f2015%2f01%2f30%2fupload-files-with-backbone.js-node.js-and-express-4.x%2f" target="_blank"><i class="fa fa-google-plus"><span>Google +1</span></i></a>
	<a class="share-button-linkedin" onClick="return popupShare(this.href);" href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fnauvalatmaja.com%2f2015%2f01%2f30%2fupload-files-with-backbone.js-node.js-and-express-4.x%2f&title=Upload%20Files%20with%20Backbone.js%2c%20Node.js%20and%20express%204.x&summary=Backbone%20fundamentals%20is%20a%20great%20free%20resource%20to%20learn%20Backbone.js%20from%20scratch.%20The%20book%20was%20written%20by%20Addy%20Osmany%20under%20creative-commons%20license.%20As%20its%20second%20exercise%2c%20the%20book%20guide%20the%20readers%20to%20create%20a%20simple%20library%20application%20that%20uses%20Node.js%20as%20the%20back-end.%20However%2c%20it%20left%20the%20part%20to%20upload%20book%26rsquo%3bs%20cover%20to%20the%20readers%20as%20an%20exercise.%20Hence%2c%20here%20is%20the%20way%20I%20did%20it.%20Requirement%20There%20are%20two%20additional%20requirements%20for%20the%20upload%20book%26rsquo%3bs%20cover%20features%3a%20-%20The%20selected%20cover%20should%20be%20previewed%20as%20thumbnail%20This%20implies%20that%20there%20should%20be%20a%20space%20to%20show%20the%20selected%20image.}&source=nauval%20atmaja" target="_blank"><i class="fa fa-linkedin"><span>Share on LinkedIn</span></i></a>
	<a class="share-button-twitter" onClick="return popupShare(this.href);" href="http://twitter.com/share?text=Upload%20Files%20with%20Backbone.js%2c%20Node.js%20and%20express%204.x&url=http%3a%2f%2fnauvalatmaja.com%2f2015%2f01%2f30%2fupload-files-with-backbone.js-node.js-and-express-4.x%2f" target="_blank"><i class="fa fa-twitter"><span>Tweet</span></i></a>	
</div>
			    

					
						<div class="post-tags">
							<i class="fa fa-tags fa-1"></i>
							
								<a class="post-tag post-tag-node.js" href="/tags/node.js">Node.js</a>
							
								<a class="post-tag post-tag-express" href="/tags/express">express</a>
							
								<a class="post-tag post-tag-backbone.js" href="/tags/backbone.js">Backbone.js</a>
							
								<a class="post-tag post-tag-upload" href="/tags/upload">upload</a>
							
								<a class="post-tag post-tag-multer" href="/tags/multer">multer</a>
							
								<a class="post-tag post-tag-backbone-fundamentals" href="/tags/backbone-fundamentals">Backbone Fundamentals</a>
							
						</div>
					

					
  <div class="paging">
    <span class="paging-label">More Reading</span>
    <div class="clear"></div>
    
      <div class="paging-older">
        <a class="paging-link" href="/2015/01/13/rendering-mermaid-in-docpad/">
          <i class="fa hta-left-white-arrow"></i> Rendering Mermaid in Docpad
        </a>
      </div>
    

    
      <div class="paging-newer">
        <a class="paging-link" href="/2015/04/09/ways-to-boost-coding-productivity/">
          Ways to Boost Coding Productivity <i class="fa hta-right-white-arrow"></i>
        </a>
      </div>
    
  </div>


					<div class="clear">

					</div>
					
		      	<aside id=comments>
    <div><h4> Comments </h4></div>
    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'nauvalatmaja';
    var disqus_identifier = 'http:\/\/nauvalatmaja.com\/2015\/01\/30\/upload-files-with-backbone.js-node.js-and-express-4.x\/';
    var disqus_title = 'Upload Files with Backbone.js, Node.js and express 4.x';
    var disqus_url = 'http:\/\/nauvalatmaja.com\/2015\/01\/30\/upload-files-with-backbone.js-node.js-and-express-4.x\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</aside>

		      
	    	</section>
				
  <section class="aboutme">
    
      <img src="/img/avatar.png">
    
    <p>Hello, my name is Nauval. I like building/crafting things. I code for living. I blog in my spare time.</p> <p>Have a look around and don't hesitate to <a href="mailto:nauval.atmaja@gmail.com">contact me</a> with any comments, suggestions or even to just say Hi!</p>
  </section>


	      <section class="footer">
	<div class="pure-menu pure-menu-horizontal pure-menu-open">
		<ul class="footer-menu">
		
		</ul>
	</div>
	<p>
		
		
			&copy; 2014-2016 Nauval Atmaja.
			<a href="http://creativecommons.org/licenses/by/3.0/">Some rights reserved</a>;
			please attribute properly and link back. Powered by <a href="http://gohugo.io/">Hugo</a>.
			Theme based on <a href="https://github.com/tmaiaroto/hugo-redlounge">hugo-redlougne</a>.
		</p>
</section>

			</div>
    </div>
  </div>
	
		<script type="text/javascript">
			onscroll = function() {
			  var toTopVisible = false;
			  var scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
			  if (scrollTop > 1000) {
			    if (!toTopVisible) {
			      document.getElementById('nav-to-top').style.display = 'block';
			    }
			  } else {
			    if (scrollTop < 1000 || toTopVisible) {
			      document.getElementById('nav-to-top').style.display = 'none';
			    }
			  }
			};
		</script>
	

	
		<script type="text/javascript">
			function popupShare(url) {
				window.open(url, '_blank', 'scrollbars,resizable,height=525,width=600');
				return false;
			}
		</script>
	

  
</body>
</html>
